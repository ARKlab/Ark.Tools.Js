"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commitChangesHelper = void 0;

var R = _interopRequireWildcard(require("ramda"));

var _sanctuary = require("sanctuary");

var _commitModsHelper = require("./commitModsHelper");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

var checkPrimaryKey = function checkPrimaryKey(_ref) {
  var row = _ref.row,
      pks = _ref.pks;
  return R.allPass(R.map(R.eqProps, pks))(row);
};

var alterMatch = R.curry(function (fn, state, row, pks) {
  return R.map(R.ifElse(checkPrimaryKey({
    row: row,
    pks: pks
  }), fn, R.identity), state);
});

var nonPrimaryKeyValuesAltered = function nonPrimaryKeyValuesAltered(modalData, pks, errMsg) {
  return R.equals(R.omit(pks, modalData.row), R.omit(pks, modalData.orig)) ? (0, _sanctuary.Left)(errMsg) : (0, _sanctuary.Right)(modalData);
};

var mapRanges = function mapRanges(list) {
  return list.map(function (row) {
    return (0, _commitModsHelper.moment)().range((0, _commitModsHelper.moment)(row.validoDal).format("YYYY-MM-DD"), (0, _commitModsHelper.moment)(row.validoAl).format("YYYY-MM-DD"));
  });
};

var periodiRangeOverlapChecker = function periodiRangeOverlapChecker(_ref2) {
  var tableData = _ref2.tableData,
      modalData = _ref2.modalData,
      selectedPeriodo = _ref2.selectedPeriodo,
      periodo = _ref2.periodo,
      periodoKeys = _ref2.periodoKeys,
      periodoErrorMsg = _ref2.periodoErrorMsg;
  var getSelectedRange = periodo.filter(function (row) {
    return row.periodo === selectedPeriodo;
  }).map(function (x) {
    return (0, _commitModsHelper.moment)().range(x.validoDal, x.validoAl);
  });
  var matchingDataPeriodo = tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: periodoKeys
  })).map(function (x) {
    return x.periodo;
  }).map(function (val) {
    return periodo.filter(function (row) {
      return row.periodo === val;
    });
  });
  var getMapRanges = R.isEmpty(matchingDataPeriodo) ? [] : mapRanges(R.head(matchingDataPeriodo));
  var resultList = getMapRanges.map(function (range) {
    return getSelectedRange[0].overlaps(range);
  });
  return R.any(R.equals(true), resultList) ? (0, _sanctuary.Left)([periodoErrorMsg]) : (0, _sanctuary.Right)(modalData);
};

var excludesPrimaryKey = R.curry(function (tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: pks
  })).length > 0 ? (0, _sanctuary.Left)([errMsg]) : periodiRangeOverlapChecker({
    tableData: tableData,
    modalData: modalData,
    selectedPeriodo: modalData.row.periodo,
    periodo: periodo,
    periodoKeys: periodoKeys,
    periodoErrorMsg: periodoErrorMsg
  });
});

var primaryKeyValuesMatch = function primaryKeyValuesMatch(modalData, pks, errMsg) {
  return R.all(function (x) {
    return R.equals(modalData.row[x], modalData.orig[x]);
  }, pks) ? (0, _sanctuary.Right)(modalData) : (0, _sanctuary.Left)([errMsg]);
};

var onlyNonPrimaryAltered = function onlyNonPrimaryAltered(modalData, pks, errMsg) {
  return R.pipe(function (x) {
    return primaryKeyValuesMatch(x, pks, errMsg);
  }, R.chain(function (x) {
    return nonPrimaryKeyValuesAltered(x, pks, errMsg);
  }))(modalData);
};

var addOrUpdate = function addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return function (modalData) {
    return (0, _commitModsHelper.sanctuaryConcat)(excludesPrimaryKey(tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg), onlyNonPrimaryAltered(modalData, pks, errMsg));
  };
};

var isUpdate = R.ifElse(R.propEq("type", "Update Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getUpdater = (0, _commitModsHelper.reader)(function (_ref3) {
  var pks = _ref3.pks,
      errMsg = _ref3.errMsg,
      modalData = _ref3.modalData,
      tableData = _ref3.tableData,
      periodo = _ref3.periodo,
      periodoKeys = _ref3.periodoKeys,
      periodoErrorMsg = _ref3.periodoErrorMsg;
  return R.pipe(isUpdate, R.chain(addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg)), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(R.assoc("original", modalData.orig.original || modalData.orig)), R.map(function (updated) {
    return alterMatch(R.always(updated), tableData, modalData.orig, pks);
  }))(modalData);
});
var isAdd = R.ifElse(R.propEq("type", "Add Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getAdder = (0, _commitModsHelper.reader)(function (_ref4) {
  var pks = _ref4.pks,
      errMsg = _ref4.errMsg,
      modalData = _ref4.modalData,
      tableData = _ref4.tableData,
      periodo = _ref4.periodo,
      periodoKeys = _ref4.periodoKeys,
      periodoErrorMsg = _ref4.periodoErrorMsg;
  return R.pipe(isAdd, R.chain(function (x) {
    return excludesPrimaryKey(tableData, x, pks, errMsg, periodo, periodoKeys, periodoErrorMsg);
  }), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(function (x) {
    return R.prepend(x, tableData);
  }))(modalData);
});
var getModifiers = R.traverse(_commitModsHelper.reader.of, R.identity, [getUpdater, getAdder]).map(R.apply(_sanctuary.concat));

var commitChangesHelper = function commitChangesHelper(_ref5) {
  var pks = _ref5.pks,
      errMsg = _ref5.errMsg,
      modalData = _ref5.modalData,
      tableData = _ref5.tableData;
  return getModifiers.run({
    pks: pks,
    errMsg: errMsg,
    modalData: modalData,
    tableData: tableData
  });
};

exports.commitChangesHelper = commitChangesHelper;
var _default = commitChangesHelper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9tYXBwaW5nVG9vbHMvY29tbWl0UGVyaW9kaU1vZGlmaWNhdGlvbi50cyJdLCJuYW1lcyI6WyJjaGVja1ByaW1hcnlLZXkiLCJyb3ciLCJwa3MiLCJSIiwiYWxsUGFzcyIsIm1hcCIsImVxUHJvcHMiLCJhbHRlck1hdGNoIiwiY3VycnkiLCJmbiIsInN0YXRlIiwiaWZFbHNlIiwiaWRlbnRpdHkiLCJub25QcmltYXJ5S2V5VmFsdWVzQWx0ZXJlZCIsIm1vZGFsRGF0YSIsImVyck1zZyIsImVxdWFscyIsIm9taXQiLCJvcmlnIiwibWFwUmFuZ2VzIiwibGlzdCIsInJhbmdlIiwidmFsaWRvRGFsIiwiZm9ybWF0IiwidmFsaWRvQWwiLCJwZXJpb2RpUmFuZ2VPdmVybGFwQ2hlY2tlciIsInRhYmxlRGF0YSIsInNlbGVjdGVkUGVyaW9kbyIsInBlcmlvZG8iLCJwZXJpb2RvS2V5cyIsInBlcmlvZG9FcnJvck1zZyIsImdldFNlbGVjdGVkUmFuZ2UiLCJmaWx0ZXIiLCJ4IiwibWF0Y2hpbmdEYXRhUGVyaW9kbyIsInZhbCIsImdldE1hcFJhbmdlcyIsImlzRW1wdHkiLCJoZWFkIiwicmVzdWx0TGlzdCIsIm92ZXJsYXBzIiwiYW55IiwiZXhjbHVkZXNQcmltYXJ5S2V5IiwibGVuZ3RoIiwicHJpbWFyeUtleVZhbHVlc01hdGNoIiwiYWxsIiwib25seU5vblByaW1hcnlBbHRlcmVkIiwicGlwZSIsImNoYWluIiwiYWRkT3JVcGRhdGUiLCJpc1VwZGF0ZSIsInByb3BFcSIsIlJpZ2h0IiwiYWx3YXlzIiwiZ2V0VXBkYXRlciIsIm0iLCJhc3NvYyIsInR5cGUiLCJvcmlnaW5hbCIsInVwZGF0ZWQiLCJpc0FkZCIsImdldEFkZGVyIiwicHJlcGVuZCIsImdldE1vZGlmaWVycyIsInRyYXZlcnNlIiwicmVhZGVyIiwib2YiLCJhcHBseSIsImNvbmNhdCIsImNvbW1pdENoYW5nZXNIZWxwZXIiLCJydW4iXSwibWFwcGluZ3MiOiI7Ozs7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YXMgUiBmcm9tIFwicmFtZGFcIjtcclxuaW1wb3J0IHsgTGVmdCwgUmlnaHQsIGNvbmNhdCB9IGZyb20gXCJzYW5jdHVhcnlcIjtcclxuaW1wb3J0IHsgcmVhZGVyLCBzYW5jdHVhcnlDb25jYXQsIG1vbWVudCB9IGZyb20gXCIuL2NvbW1pdE1vZHNIZWxwZXJcIjtcclxuXHJcbmNvbnN0IGNoZWNrUHJpbWFyeUtleSA9ICh7IHJvdywgcGtzIH06IHsgcm93OiBhbnk7IHBrczogYW55IH0pOiBhbnkgPT5cclxuICBSLmFsbFBhc3MoUi5tYXAoUi5lcVByb3BzLCBwa3MpKShyb3cpO1xyXG5cclxuY29uc3QgYWx0ZXJNYXRjaCA9IFIuY3VycnkoKGZuOiBhbnksIHN0YXRlOiBhbnksIHJvdzogYW55LCBwa3M6IGFueSkgPT5cclxuICBSLm1hcChSLmlmRWxzZShjaGVja1ByaW1hcnlLZXkoeyByb3csIHBrcyB9KSwgZm4sIFIuaWRlbnRpdHkpLCBzdGF0ZSlcclxuKTtcclxuXHJcbmNvbnN0IG5vblByaW1hcnlLZXlWYWx1ZXNBbHRlcmVkID0gKFxyXG4gIG1vZGFsRGF0YTogYW55LFxyXG4gIHBrczogYW55LFxyXG4gIGVyck1zZzogc3RyaW5nXHJcbik6IGFueSA9PlxyXG4gIFIuZXF1YWxzKFIub21pdChwa3MsIG1vZGFsRGF0YS5yb3cpLCBSLm9taXQocGtzLCBtb2RhbERhdGEub3JpZykpXHJcbiAgICA/IExlZnQoZXJyTXNnKVxyXG4gICAgOiBSaWdodChtb2RhbERhdGEpO1xyXG5cclxuY29uc3QgbWFwUmFuZ2VzID0gKGxpc3Q6IGFueSkgPT5cclxuICBsaXN0Lm1hcCgocm93OiBhbnkpID0+XHJcbiAgICBtb21lbnQoKS5yYW5nZShcclxuICAgICAgbW9tZW50KHJvdy52YWxpZG9EYWwpLmZvcm1hdChcIllZWVktTU0tRERcIiksXHJcbiAgICAgIG1vbWVudChyb3cudmFsaWRvQWwpLmZvcm1hdChcIllZWVktTU0tRERcIilcclxuICAgIClcclxuICApO1xyXG5cclxuY29uc3QgcGVyaW9kaVJhbmdlT3ZlcmxhcENoZWNrZXIgPSAoe1xyXG4gIHRhYmxlRGF0YSxcclxuICBtb2RhbERhdGEsXHJcbiAgc2VsZWN0ZWRQZXJpb2RvLFxyXG4gIHBlcmlvZG8sXHJcbiAgcGVyaW9kb0tleXMsXHJcbiAgcGVyaW9kb0Vycm9yTXNnXHJcbn06IHtcclxuICB0YWJsZURhdGE6IGFueTtcclxuICBtb2RhbERhdGE6IGFueTtcclxuICBzZWxlY3RlZFBlcmlvZG86IGFueTtcclxuICBwZXJpb2RvOiBhbnk7XHJcbiAgcGVyaW9kb0tleXM6IGFueTtcclxuICBwZXJpb2RvRXJyb3JNc2c6IGFueTtcclxufSkgPT4ge1xyXG4gIGNvbnN0IGdldFNlbGVjdGVkUmFuZ2UgPSBwZXJpb2RvXHJcbiAgICAuZmlsdGVyKChyb3c6IGFueSkgPT4gcm93LnBlcmlvZG8gPT09IHNlbGVjdGVkUGVyaW9kbylcclxuICAgIC5tYXAoKHg6IGFueSkgPT4gbW9tZW50KCkucmFuZ2UoeC52YWxpZG9EYWwsIHgudmFsaWRvQWwpKTtcclxuXHJcbiAgY29uc3QgbWF0Y2hpbmdEYXRhUGVyaW9kbyA9IHRhYmxlRGF0YVxyXG4gICAgLmZpbHRlcihjaGVja1ByaW1hcnlLZXkoeyByb3c6IG1vZGFsRGF0YS5yb3csIHBrczogcGVyaW9kb0tleXMgfSkpXHJcbiAgICAubWFwKCh4OiBhbnkpID0+IHgucGVyaW9kbylcclxuICAgIC5tYXAoKHZhbDogYW55KSA9PiBwZXJpb2RvLmZpbHRlcihyb3cgPT4gcm93LnBlcmlvZG8gPT09IHZhbCkpO1xyXG5cclxuICBjb25zdCBnZXRNYXBSYW5nZXMgPSBSLmlzRW1wdHkobWF0Y2hpbmdEYXRhUGVyaW9kbylcclxuICAgID8gW11cclxuICAgIDogbWFwUmFuZ2VzKFIuaGVhZChtYXRjaGluZ0RhdGFQZXJpb2RvKSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdExpc3QgPSBnZXRNYXBSYW5nZXMubWFwKChyYW5nZTogYW55KSA9PlxyXG4gICAgZ2V0U2VsZWN0ZWRSYW5nZVswXS5vdmVybGFwcyhyYW5nZSlcclxuICApO1xyXG5cclxuICByZXR1cm4gUi5hbnkoUi5lcXVhbHModHJ1ZSksIHJlc3VsdExpc3QpXHJcbiAgICA/IExlZnQoW3BlcmlvZG9FcnJvck1zZ10pXHJcbiAgICA6IFJpZ2h0KG1vZGFsRGF0YSk7XHJcbn07XHJcblxyXG5jb25zdCBleGNsdWRlc1ByaW1hcnlLZXkgPSBSLmN1cnJ5KFxyXG4gIChcclxuICAgIHRhYmxlRGF0YTogYW55LFxyXG4gICAgbW9kYWxEYXRhOiBhbnksXHJcbiAgICBwa3M6IGFueSxcclxuICAgIGVyck1zZzogc3RyaW5nLFxyXG4gICAgcGVyaW9kbzogYW55LFxyXG4gICAgcGVyaW9kb0tleXM6IGFueSxcclxuICAgIHBlcmlvZG9FcnJvck1zZzogYW55XHJcbiAgKTogYW55ID0+XHJcbiAgICB0YWJsZURhdGEuZmlsdGVyKGNoZWNrUHJpbWFyeUtleSh7IHJvdzogbW9kYWxEYXRhLnJvdywgcGtzIH0pKS5sZW5ndGggPiAwXHJcbiAgICAgID8gTGVmdChbZXJyTXNnXSlcclxuICAgICAgOiBwZXJpb2RpUmFuZ2VPdmVybGFwQ2hlY2tlcih7XHJcbiAgICAgICAgICB0YWJsZURhdGEsXHJcbiAgICAgICAgICBtb2RhbERhdGEsXHJcbiAgICAgICAgICBzZWxlY3RlZFBlcmlvZG86IG1vZGFsRGF0YS5yb3cucGVyaW9kbyxcclxuICAgICAgICAgIHBlcmlvZG8sXHJcbiAgICAgICAgICBwZXJpb2RvS2V5cyxcclxuICAgICAgICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gICAgICAgIH0pXHJcbik7XHJcblxyXG5jb25zdCBwcmltYXJ5S2V5VmFsdWVzTWF0Y2ggPSAobW9kYWxEYXRhOiBhbnksIHBrczogYW55LCBlcnJNc2c6IHN0cmluZyk6IGFueSA9PlxyXG4gIFIuYWxsKCh4OiBhbnkpID0+IFIuZXF1YWxzKG1vZGFsRGF0YS5yb3dbeF0sIG1vZGFsRGF0YS5vcmlnW3hdKSwgcGtzKVxyXG4gICAgPyBSaWdodChtb2RhbERhdGEpXHJcbiAgICA6IExlZnQoW2Vyck1zZ10pO1xyXG5cclxuY29uc3Qgb25seU5vblByaW1hcnlBbHRlcmVkID0gKG1vZGFsRGF0YTogYW55LCBwa3M6IGFueSwgZXJyTXNnOiBzdHJpbmcpID0+XHJcbiAgUi5waXBlKFxyXG4gICAgKHg6IGFueSkgPT4gcHJpbWFyeUtleVZhbHVlc01hdGNoKHgsIHBrcywgZXJyTXNnKSxcclxuICAgIFIuY2hhaW4oeCA9PiBub25QcmltYXJ5S2V5VmFsdWVzQWx0ZXJlZCh4LCBwa3MsIGVyck1zZykpXHJcbiAgKShtb2RhbERhdGEpO1xyXG5cclxuY29uc3QgYWRkT3JVcGRhdGUgPSAoXHJcbiAgdGFibGVEYXRhOiBhbnksXHJcbiAgcGtzOiBhbnksXHJcbiAgZXJyTXNnOiBzdHJpbmcsXHJcbiAgcGVyaW9kbzogYW55LFxyXG4gIHBlcmlvZG9LZXlzOiBhbnksXHJcbiAgcGVyaW9kb0Vycm9yTXNnOiBhbnlcclxuKTogYW55ID0+IChtb2RhbERhdGE6IGFueSkgPT5cclxuICBzYW5jdHVhcnlDb25jYXQoXHJcbiAgICBleGNsdWRlc1ByaW1hcnlLZXkoXHJcbiAgICAgIHRhYmxlRGF0YSxcclxuICAgICAgbW9kYWxEYXRhLFxyXG4gICAgICBwa3MsXHJcbiAgICAgIGVyck1zZyxcclxuICAgICAgcGVyaW9kbyxcclxuICAgICAgcGVyaW9kb0tleXMsXHJcbiAgICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gICAgKSxcclxuICAgIG9ubHlOb25QcmltYXJ5QWx0ZXJlZChtb2RhbERhdGEsIHBrcywgZXJyTXNnKVxyXG4gICk7XHJcblxyXG5jb25zdCBpc1VwZGF0ZSA9IFIuaWZFbHNlKFxyXG4gIFIucHJvcEVxKFwidHlwZVwiLCBcIlVwZGF0ZSBNYXBwaW5nXCIpLFxyXG4gIFJpZ2h0LFxyXG4gIFIuYWx3YXlzKExlZnQoW10pKVxyXG4pO1xyXG5cclxuY29uc3QgZ2V0VXBkYXRlciA9IHJlYWRlcihcclxuICAoe1xyXG4gICAgcGtzLFxyXG4gICAgZXJyTXNnLFxyXG4gICAgbW9kYWxEYXRhLFxyXG4gICAgdGFibGVEYXRhLFxyXG4gICAgcGVyaW9kbyxcclxuICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgfToge1xyXG4gICAgcGtzOiBhbnk7XHJcbiAgICBlcnJNc2c6IHN0cmluZztcclxuICAgIG1vZGFsRGF0YTogYW55O1xyXG4gICAgdGFibGVEYXRhOiBhbnk7XHJcbiAgICBwZXJpb2RvOiBhbnk7XHJcbiAgICBwZXJpb2RvS2V5czogYW55O1xyXG4gICAgcGVyaW9kb0Vycm9yTXNnOiBhbnk7XHJcbiAgfSkgPT5cclxuICAgIFIucGlwZShcclxuICAgICAgaXNVcGRhdGUsXHJcbiAgICAgIFIuY2hhaW4oXHJcbiAgICAgICAgYWRkT3JVcGRhdGUoXHJcbiAgICAgICAgICB0YWJsZURhdGEsXHJcbiAgICAgICAgICBwa3MsXHJcbiAgICAgICAgICBlcnJNc2csXHJcbiAgICAgICAgICBwZXJpb2RvLFxyXG4gICAgICAgICAgcGVyaW9kb0tleXMsXHJcbiAgICAgICAgICBwZXJpb2RvRXJyb3JNc2dcclxuICAgICAgICApXHJcbiAgICAgICksXHJcbiAgICAgIFIubWFwKChtOiBhbnkpID0+IFIuYXNzb2MoXCJtb2RcIiwgbS50eXBlLCBtLnJvdykpLFxyXG4gICAgICBSLm1hcChSLmFzc29jKFwib3JpZ2luYWxcIiwgbW9kYWxEYXRhLm9yaWcub3JpZ2luYWwgfHwgbW9kYWxEYXRhLm9yaWcpKSxcclxuICAgICAgUi5tYXAodXBkYXRlZCA9PlxyXG4gICAgICAgIGFsdGVyTWF0Y2goUi5hbHdheXModXBkYXRlZCksIHRhYmxlRGF0YSwgbW9kYWxEYXRhLm9yaWcsIHBrcylcclxuICAgICAgKVxyXG4gICAgKShtb2RhbERhdGEpXHJcbik7XHJcblxyXG5jb25zdCBpc0FkZCA9IFIuaWZFbHNlKFxyXG4gIFIucHJvcEVxKFwidHlwZVwiLCBcIkFkZCBNYXBwaW5nXCIpLFxyXG4gIFJpZ2h0LFxyXG4gIFIuYWx3YXlzKExlZnQoW10pKVxyXG4pO1xyXG5jb25zdCBnZXRBZGRlciA9IHJlYWRlcihcclxuICAoe1xyXG4gICAgcGtzLFxyXG4gICAgZXJyTXNnLFxyXG4gICAgbW9kYWxEYXRhLFxyXG4gICAgdGFibGVEYXRhLFxyXG4gICAgcGVyaW9kbyxcclxuICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgfToge1xyXG4gICAgcGtzOiBhbnk7XHJcbiAgICBlcnJNc2c6IHN0cmluZztcclxuICAgIG1vZGFsRGF0YTogYW55O1xyXG4gICAgdGFibGVEYXRhOiBhbnk7XHJcbiAgICBwZXJpb2RvOiBhbnk7XHJcbiAgICBwZXJpb2RvS2V5czogYW55O1xyXG4gICAgcGVyaW9kb0Vycm9yTXNnOiBhbnk7XHJcbiAgfSkgPT5cclxuICAgIFIucGlwZShcclxuICAgICAgaXNBZGQsXHJcbiAgICAgIFIuY2hhaW4oeCA9PlxyXG4gICAgICAgIGV4Y2x1ZGVzUHJpbWFyeUtleShcclxuICAgICAgICAgIHRhYmxlRGF0YSxcclxuICAgICAgICAgIHgsXHJcbiAgICAgICAgICBwa3MsXHJcbiAgICAgICAgICBlcnJNc2csXHJcbiAgICAgICAgICBwZXJpb2RvLFxyXG4gICAgICAgICAgcGVyaW9kb0tleXMsXHJcbiAgICAgICAgICBwZXJpb2RvRXJyb3JNc2dcclxuICAgICAgICApXHJcbiAgICAgICksXHJcbiAgICAgIFIubWFwKChtOiBhbnkpID0+IFIuYXNzb2MoXCJtb2RcIiwgbS50eXBlLCBtLnJvdykpLFxyXG4gICAgICBSLm1hcCh4ID0+IFIucHJlcGVuZCh4LCB0YWJsZURhdGEpKVxyXG4gICAgKShtb2RhbERhdGEpXHJcbik7XHJcbmNvbnN0IGdldE1vZGlmaWVycyA9IFIudHJhdmVyc2U8YW55LCBhbnksIGFueT4ocmVhZGVyLm9mLCBSLmlkZW50aXR5LCBbXHJcbiAgZ2V0VXBkYXRlcixcclxuICBnZXRBZGRlclxyXG5dKS5tYXAoUi5hcHBseShjb25jYXQpKTtcclxuXHJcbmV4cG9ydCBjb25zdCBjb21taXRDaGFuZ2VzSGVscGVyID0gKHtcclxuICBwa3MsXHJcbiAgZXJyTXNnLFxyXG4gIG1vZGFsRGF0YSxcclxuICB0YWJsZURhdGFcclxufToge1xyXG4gIHBrczogYW55O1xyXG4gIGVyck1zZzogc3RyaW5nO1xyXG4gIG1vZGFsRGF0YTogYW55O1xyXG4gIHRhYmxlRGF0YTogYW55O1xyXG59KSA9PlxyXG4gIGdldE1vZGlmaWVycy5ydW4oe1xyXG4gICAgcGtzLFxyXG4gICAgZXJyTXNnLFxyXG4gICAgbW9kYWxEYXRhLFxyXG4gICAgdGFibGVEYXRhXHJcbiAgfSk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjb21taXRDaGFuZ2VzSGVscGVyO1xyXG4iXX0=