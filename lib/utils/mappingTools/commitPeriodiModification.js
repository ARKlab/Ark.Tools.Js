"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commitPeriodiModification = void 0;

var R = _interopRequireWildcard(require("ramda"));

var _sanctuary = require("sanctuary");

var _commitModsHelper = require("./commitModsHelper");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

var checkPrimaryKey = function checkPrimaryKey(_ref) {
  var row = _ref.row,
      pks = _ref.pks;
  return R.allPass(R.map(R.eqProps, pks))(row);
};

var alterMatch = R.curry(function (fn, state, row, pks) {
  return R.map(R.ifElse(checkPrimaryKey({
    row: row,
    pks: pks
  }), fn, R.identity), state);
});

var nonPrimaryKeyValuesAltered = function nonPrimaryKeyValuesAltered(modalData, pks, errMsg) {
  return R.equals(R.omit(pks, modalData.row), R.omit(pks, modalData.orig)) ? (0, _sanctuary.Left)(errMsg) : (0, _sanctuary.Right)(modalData);
};

var mapRanges = function mapRanges(list) {
  return list.map(function (row) {
    return (0, _commitModsHelper.moment)().range((0, _commitModsHelper.moment)(row.validoDal).format("YYYY-MM-DD"), (0, _commitModsHelper.moment)(row.validoAl).format("YYYY-MM-DD"));
  });
};

var periodiRangeOverlapChecker = function periodiRangeOverlapChecker(_ref2) {
  var tableData = _ref2.tableData,
      modalData = _ref2.modalData,
      selectedPeriodo = _ref2.selectedPeriodo,
      periodo = _ref2.periodo,
      periodoKeys = _ref2.periodoKeys,
      periodoErrorMsg = _ref2.periodoErrorMsg;
  debugger;
  var getSelectedRange = periodo.filter(function (row) {
    return row.periodo === selectedPeriodo;
  }).map(function (x) {
    return (0, _commitModsHelper.moment)().range(x.validoDal, x.validoAl);
  });
  var matchingDataPeriodo = tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: periodoKeys
  })).map(function (x) {
    return x.periodo;
  }).map(function (val) {
    return periodo.filter(function (row) {
      return row.periodo === val;
    });
  });
  var getMapRanges = R.isEmpty(matchingDataPeriodo) ? [] : mapRanges(R.head(matchingDataPeriodo));
  var resultList = getMapRanges.map(function (range) {
    return getSelectedRange[0].overlaps(range);
  });
  return R.any(R.equals(true), resultList) ? (0, _sanctuary.Left)([periodoErrorMsg]) : (0, _sanctuary.Right)(modalData);
};

var excludesPrimaryKey = R.curry(function (tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: pks
  })).length > 0 ? (0, _sanctuary.Left)([errMsg]) : periodiRangeOverlapChecker({
    tableData: tableData,
    modalData: modalData,
    selectedPeriodo: modalData.row.periodo,
    periodo: periodo,
    periodoKeys: periodoKeys,
    periodoErrorMsg: periodoErrorMsg
  });
});

var primaryKeyValuesMatch = function primaryKeyValuesMatch(modalData, pks, errMsg) {
  return R.all(function (x) {
    return R.equals(modalData.row[x], modalData.orig[x]);
  }, pks) ? (0, _sanctuary.Right)(modalData) : (0, _sanctuary.Left)([errMsg]);
};

var onlyNonPrimaryAltered = function onlyNonPrimaryAltered(modalData, pks, errMsg) {
  return R.pipe(function (x) {
    return primaryKeyValuesMatch(x, pks, errMsg);
  }, R.chain(function (x) {
    return nonPrimaryKeyValuesAltered(x, pks, errMsg);
  }))(modalData);
};

var addOrUpdate = function addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return function (modalData) {
    return (0, _commitModsHelper.sanctuaryConcat)(excludesPrimaryKey(tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg), onlyNonPrimaryAltered(modalData, pks, errMsg));
  };
};

var isUpdate = R.ifElse(R.propEq("type", "Update Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getUpdater = (0, _commitModsHelper.reader)(function (_ref3) {
  var pks = _ref3.pks,
      errMsg = _ref3.errMsg,
      modalData = _ref3.modalData,
      tableData = _ref3.tableData,
      periodo = _ref3.periodo,
      periodoKeys = _ref3.periodoKeys,
      periodoErrorMsg = _ref3.periodoErrorMsg;
  return R.pipe(isUpdate, R.chain(addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg)), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(R.assoc("original", modalData.orig.original || modalData.orig)), R.map(function (updated) {
    return alterMatch(R.always(updated), tableData, modalData.orig, pks);
  }))(modalData);
});
var isAdd = R.ifElse(R.propEq("type", "Add Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getAdder = (0, _commitModsHelper.reader)(function (_ref4) {
  var pks = _ref4.pks,
      errMsg = _ref4.errMsg,
      modalData = _ref4.modalData,
      tableData = _ref4.tableData,
      periodo = _ref4.periodo,
      periodoKeys = _ref4.periodoKeys,
      periodoErrorMsg = _ref4.periodoErrorMsg;
  return R.pipe(isAdd, R.chain(function (x) {
    return excludesPrimaryKey(tableData, x, pks, errMsg, periodo, periodoKeys, periodoErrorMsg);
  }), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(function (x) {
    return R.prepend(x, tableData);
  }))(modalData);
});
var getModifiers = R.traverse(_commitModsHelper.reader.of, R.identity, [getUpdater, getAdder]).map(R.apply(_sanctuary.concat));

var commitPeriodiModification = function commitPeriodiModification(_ref5) {
  var pks = _ref5.pks,
      errMsg = _ref5.errMsg,
      modalData = _ref5.modalData,
      tableData = _ref5.tableData,
      periodo = _ref5.periodo,
      periodoKeys = _ref5.periodoKeys,
      periodoErrorMsg = _ref5.periodoErrorMsg;
  return getModifiers.run({
    pks: pks,
    errMsg: errMsg,
    modalData: modalData,
    tableData: tableData,
    periodo: periodo,
    periodoKeys: periodoKeys,
    periodoErrorMsg: periodoErrorMsg
  });
};

exports.commitPeriodiModification = commitPeriodiModification;
var _default = commitPeriodiModification;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9tYXBwaW5nVG9vbHMvY29tbWl0UGVyaW9kaU1vZGlmaWNhdGlvbi50cyJdLCJuYW1lcyI6WyJjaGVja1ByaW1hcnlLZXkiLCJyb3ciLCJwa3MiLCJSIiwiYWxsUGFzcyIsIm1hcCIsImVxUHJvcHMiLCJhbHRlck1hdGNoIiwiY3VycnkiLCJmbiIsInN0YXRlIiwiaWZFbHNlIiwiaWRlbnRpdHkiLCJub25QcmltYXJ5S2V5VmFsdWVzQWx0ZXJlZCIsIm1vZGFsRGF0YSIsImVyck1zZyIsImVxdWFscyIsIm9taXQiLCJvcmlnIiwibWFwUmFuZ2VzIiwibGlzdCIsInJhbmdlIiwidmFsaWRvRGFsIiwiZm9ybWF0IiwidmFsaWRvQWwiLCJwZXJpb2RpUmFuZ2VPdmVybGFwQ2hlY2tlciIsInRhYmxlRGF0YSIsInNlbGVjdGVkUGVyaW9kbyIsInBlcmlvZG8iLCJwZXJpb2RvS2V5cyIsInBlcmlvZG9FcnJvck1zZyIsImdldFNlbGVjdGVkUmFuZ2UiLCJmaWx0ZXIiLCJ4IiwibWF0Y2hpbmdEYXRhUGVyaW9kbyIsInZhbCIsImdldE1hcFJhbmdlcyIsImlzRW1wdHkiLCJoZWFkIiwicmVzdWx0TGlzdCIsIm92ZXJsYXBzIiwiYW55IiwiZXhjbHVkZXNQcmltYXJ5S2V5IiwibGVuZ3RoIiwicHJpbWFyeUtleVZhbHVlc01hdGNoIiwiYWxsIiwib25seU5vblByaW1hcnlBbHRlcmVkIiwicGlwZSIsImNoYWluIiwiYWRkT3JVcGRhdGUiLCJpc1VwZGF0ZSIsInByb3BFcSIsIlJpZ2h0IiwiYWx3YXlzIiwiZ2V0VXBkYXRlciIsIm0iLCJhc3NvYyIsInR5cGUiLCJvcmlnaW5hbCIsInVwZGF0ZWQiLCJpc0FkZCIsImdldEFkZGVyIiwicHJlcGVuZCIsImdldE1vZGlmaWVycyIsInRyYXZlcnNlIiwicmVhZGVyIiwib2YiLCJhcHBseSIsImNvbmNhdCIsImNvbW1pdFBlcmlvZGlNb2RpZmljYXRpb24iLCJydW4iXSwibWFwcGluZ3Mi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LEVBQVRBLFNBSGU7QUFJZlksSUFBQUEsU0FBUyxFQUFUQSxTQUplO0FBS2ZFLElBQUFBLE9BQU8sRUFBUEEsT0FMZTtBQU1mQyxJQUFBQSxXQUFXLEVBQVhBLFdBTmU7QUFPZkMsSUFBQUEsZUFBZSxFQUFmQTtBQVBlLEdBQWpCLENBakJ1QztBQUFBLENBQWxDOzs7ZUEyQlF1Qyx5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFIgZnJvbSBcInJhbWRhXCI7XHJcbmltcG9ydCB7IExlZnQsIFJpZ2h0LCBjb25jYXQgfSBmcm9tIFwic2FuY3R1YXJ5XCI7XHJcbmltcG9ydCB7IHJlYWRlciwgc2FuY3R1YXJ5Q29uY2F0LCBtb21lbnQgfSBmcm9tIFwiLi9jb21taXRNb2RzSGVscGVyXCI7XHJcblxyXG5jb25zdCBjaGVja1ByaW1hcnlLZXkgPSAoeyByb3csIHBrcyB9OiB7IHJvdzogYW55OyBwa3M6IGFueSB9KTogYW55ID0+XHJcbiAgUi5hbGxQYXNzKFIubWFwKFIuZXFQcm9wcywgcGtzKSkocm93KTtcclxuXHJcbmNvbnN0IGFsdGVyTWF0Y2ggPSBSLmN1cnJ5KChmbjogYW55LCBzdGF0ZTogYW55LCByb3c6IGFueSwgcGtzOiBhbnkpID0+XHJcbiAgUi5tYXAoUi5pZkVsc2UoY2hlY2tQcmltYXJ5S2V5KHsgcm93LCBwa3MgfSksIGZuLCBSLmlkZW50aXR5KSwgc3RhdGUpXHJcbik7XHJcblxyXG5jb25zdCBub25QcmltYXJ5S2V5VmFsdWVzQWx0ZXJlZCA9IChcclxuICBtb2RhbERhdGE6IGFueSxcclxuICBwa3M6IGFueSxcclxuICBlcnJNc2c6IHN0cmluZ1xyXG4pOiBhbnkgPT5cclxuICBSLmVxdWFscyhSLm9taXQocGtzLCBtb2RhbERhdGEucm93KSwgUi5vbWl0KHBrcywgbW9kYWxEYXRhLm9yaWcpKVxyXG4gICAgPyBMZWZ0KGVyck1zZylcclxuICAgIDogUmlnaHQobW9kYWxEYXRhKTtcclxuXHJcbmNvbnN0IG1hcFJhbmdlcyA9IChsaXN0OiBhbnkpID0+XHJcbiAgbGlzdC5tYXAoKHJvdzogYW55KSA9PlxyXG4gICAgbW9tZW50KCkucmFuZ2UoXHJcbiAgICAgIG1vbWVudChyb3cudmFsaWRvRGFsKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpLFxyXG4gICAgICBtb21lbnQocm93LnZhbGlkb0FsKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpXHJcbiAgICApXHJcbiAgKTtcclxuXHJcbmNvbnN0IHBlcmlvZGlSYW5nZU92ZXJsYXBDaGVja2VyID0gKHtcclxuICB0YWJsZURhdGEsXHJcbiAgbW9kYWxEYXRhLFxyXG4gIHNlbGVjdGVkUGVyaW9kbyxcclxuICBwZXJpb2RvLFxyXG4gIHBlcmlvZG9LZXlzLFxyXG4gIHBlcmlvZG9FcnJvck1zZ1xyXG59OiB7XHJcbiAgdGFibGVEYXRhOiBhbnk7XHJcbiAgbW9kYWxEYXRhOiBhbnk7XHJcbiAgc2VsZWN0ZWRQZXJpb2RvOiBhbnk7XHJcbiAgcGVyaW9kbzogYW55O1xyXG4gIHBlcmlvZG9LZXlzOiBhbnk7XHJcbiAgcGVyaW9kb0Vycm9yTXNnOiBhbnk7XHJcbn0pID0+IHtcclxuICBkZWJ1Z2dlcjtcclxuICBjb25zdCBnZXRTZWxlY3RlZFJhbmdlID0gcGVyaW9kb1xyXG4gICAgLmZpbHRlcigocm93OiBhbnkpID0+IHJvdy5wZXJpb2RvID09PSBzZWxlY3RlZFBlcmlvZG8pXHJcbiAgICAubWFwKCh4OiBhbnkpID0+IG1vbWVudCgpLnJhbmdlKHgudmFsaWRvRGFsLCB4LnZhbGlkb0FsKSk7XHJcblxyXG4gIGNvbnN0IG1hdGNoaW5nRGF0YVBlcmlvZG8gPSB0YWJsZURhdGFcclxuICAgIC5maWx0ZXIoY2hlY2tQcmltYXJ5S2V5KHsgcm93OiBtb2RhbERhdGEucm93LCBwa3M6IHBlcmlvZG9LZXlzIH0pKVxyXG4gICAgLm1hcCgoeDogYW55KSA9PiB4LnBlcmlvZG8pXHJcbiAgICAubWFwKCh2YWw6IGFueSkgPT4gcGVyaW9kby5maWx0ZXIocm93ID0+IHJvdy5wZXJpb2RvID09PSB2YWwpKTtcclxuXHJcbiAgY29uc3QgZ2V0TWFwUmFuZ2VzID0gUi5pc0VtcHR5KG1hdGNoaW5nRGF0YVBlcmlvZG8pXHJcbiAgICA/IFtdXHJcbiAgICA6IG1hcFJhbmdlcyhSLmhlYWQobWF0Y2hpbmdEYXRhUGVyaW9kbykpO1xyXG5cclxuICBjb25zdCByZXN1bHRMaXN0ID0gZ2V0TWFwUmFuZ2VzLm1hcCgocmFuZ2U6IGFueSkgPT5cclxuICAgIGdldFNlbGVjdGVkUmFuZ2VbMF0ub3ZlcmxhcHMocmFuZ2UpXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIFIuYW55KFIuZXF1YWxzKHRydWUpLCByZXN1bHRMaXN0KVxyXG4gICAgPyBMZWZ0KFtwZXJpb2RvRXJyb3JNc2ddKVxyXG4gICAgOiBSaWdodChtb2RhbERhdGEpO1xyXG59O1xyXG5cclxuY29uc3QgZXhjbHVkZXNQcmltYXJ5S2V5ID0gUi5jdXJyeShcclxuICAoXHJcbiAgICB0YWJsZURhdGE6IGFueSxcclxuICAgIG1vZGFsRGF0YTogYW55LFxyXG4gICAgcGtzOiBhbnksXHJcbiAgICBlcnJNc2c6IHN0cmluZyxcclxuICAgIHBlcmlvZG86IGFueSxcclxuICAgIHBlcmlvZG9LZXlzOiBhbnksXHJcbiAgICBwZXJpb2RvRXJyb3JNc2c6IGFueVxyXG4gICk6IGFueSA9PlxyXG4gICAgdGFibGVEYXRhLmZpbHRlcihjaGVja1ByaW1hcnlLZXkoeyByb3c6IG1vZGFsRGF0YS5yb3csIHBrcyB9KSkubGVuZ3RoID4gMFxyXG4gICAgICA/IExlZnQoW2Vyck1zZ10pXHJcbiAgICAgIDogcGVyaW9kaVJhbmdlT3ZlcmxhcENoZWNrZXIoe1xyXG4gICAgICAgICAgdGFibGVEYXRhLFxyXG4gICAgICAgICAgbW9kYWxEYXRhLFxyXG4gICAgICAgICAgc2VsZWN0ZWRQZXJpb2RvOiBtb2RhbERhdGEucm93LnBlcmlvZG8sXHJcbiAgICAgICAgICBwZXJpb2RvLFxyXG4gICAgICAgICAgcGVyaW9kb0tleXMsXHJcbiAgICAgICAgICBwZXJpb2RvRXJyb3JNc2dcclxuICAgICAgICB9KVxyXG4pO1xyXG5cclxuY29uc3QgcHJpbWFyeUtleVZhbHVlc01hdGNoID0gKG1vZGFsRGF0YTogYW55LCBwa3M6IGFueSwgZXJyTXNnOiBzdHJpbmcpOiBhbnkgPT5cclxuICBSLmFsbCgoeDogYW55KSA9PiBSLmVxdWFscyhtb2RhbERhdGEucm93W3hdLCBtb2RhbERhdGEub3JpZ1t4XSksIHBrcylcclxuICAgID8gUmlnaHQobW9kYWxEYXRhKVxyXG4gICAgOiBMZWZ0KFtlcnJNc2ddKTtcclxuXHJcbmNvbnN0IG9ubHlOb25QcmltYXJ5QWx0ZXJlZCA9IChtb2RhbERhdGE6IGFueSwgcGtzOiBhbnksIGVyck1zZzogc3RyaW5nKSA9PlxyXG4gIFIucGlwZShcclxuICAgICh4OiBhbnkpID0+IHByaW1hcnlLZXlWYWx1ZXNNYXRjaCh4LCBwa3MsIGVyck1zZyksXHJcbiAgICBSLmNoYWluKHggPT4gbm9uUHJpbWFyeUtleVZhbHVlc0FsdGVyZWQoeCwgcGtzLCBlcnJNc2cpKVxyXG4gICkobW9kYWxEYXRhKTtcclxuXHJcbmNvbnN0IGFkZE9yVXBkYXRlID0gKFxyXG4gIHRhYmxlRGF0YTogYW55LFxyXG4gIHBrczogYW55LFxyXG4gIGVyck1zZzogc3RyaW5nLFxyXG4gIHBlcmlvZG86IGFueSxcclxuICBwZXJpb2RvS2V5czogYW55LFxyXG4gIHBlcmlvZG9FcnJvck1zZzogYW55XHJcbik6IGFueSA9PiAobW9kYWxEYXRhOiBhbnkpID0+XHJcbiAgc2FuY3R1YXJ5Q29uY2F0KFxyXG4gICAgZXhjbHVkZXNQcmltYXJ5S2V5KFxyXG4gICAgICB0YWJsZURhdGEsXHJcbiAgICAgIG1vZGFsRGF0YSxcclxuICAgICAgcGtzLFxyXG4gICAgICBlcnJNc2csXHJcbiAgICAgIHBlcmlvZG8sXHJcbiAgICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgICBwZXJpb2RvRXJyb3JNc2dcclxuICAgICksXHJcbiAgICBvbmx5Tm9uUHJpbWFyeUFsdGVyZWQobW9kYWxEYXRhLCBwa3MsIGVyck1zZylcclxuICApO1xyXG5cclxuY29uc3QgaXNVcGRhdGUgPSBSLmlmRWxzZShcclxuICBSLnByb3BFcShcInR5cGVcIiwgXCJVcGRhdGUgTWFwcGluZ1wiKSxcclxuICBSaWdodCxcclxuICBSLmFsd2F5cyhMZWZ0KFtdKSlcclxuKTtcclxuXHJcbmNvbnN0IGdldFVwZGF0ZXIgPSByZWFkZXIoXHJcbiAgKHtcclxuICAgIHBrcyxcclxuICAgIGVyck1zZyxcclxuICAgIG1vZGFsRGF0YSxcclxuICAgIHRhYmxlRGF0YSxcclxuICAgIHBlcmlvZG8sXHJcbiAgICBwZXJpb2RvS2V5cyxcclxuICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gIH06IHtcclxuICAgIHBrczogYW55O1xyXG4gICAgZXJyTXNnOiBzdHJpbmc7XHJcbiAgICBtb2RhbERhdGE6IGFueTtcclxuICAgIHRhYmxlRGF0YTogYW55O1xyXG4gICAgcGVyaW9kbzogYW55O1xyXG4gICAgcGVyaW9kb0tleXM6IGFueTtcclxuICAgIHBlcmlvZG9FcnJvck1zZzogYW55O1xyXG4gIH0pID0+XHJcbiAgICBSLnBpcGUoXHJcbiAgICAgIGlzVXBkYXRlLFxyXG4gICAgICBSLmNoYWluKFxyXG4gICAgICAgIGFkZE9yVXBkYXRlKFxyXG4gICAgICAgICAgdGFibGVEYXRhLFxyXG4gICAgICAgICAgcGtzLFxyXG4gICAgICAgICAgZXJyTXNnLFxyXG4gICAgICAgICAgcGVyaW9kbyxcclxuICAgICAgICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgICAgICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgICAgICAgKVxyXG4gICAgICApLFxyXG4gICAgICBSLm1hcCgobTogYW55KSA9PiBSLmFzc29jKFwibW9kXCIsIG0udHlwZSwgbS5yb3cpKSxcclxuICAgICAgUi5tYXAoUi5hc3NvYyhcIm9yaWdpbmFsXCIsIG1vZGFsRGF0YS5vcmlnLm9yaWdpbmFsIHx8IG1vZGFsRGF0YS5vcmlnKSksXHJcbiAgICAgIFIubWFwKHVwZGF0ZWQgPT5cclxuICAgICAgICBhbHRlck1hdGNoKFIuYWx3YXlzKHVwZGF0ZWQpLCB0YWJsZURhdGEsIG1vZGFsRGF0YS5vcmlnLCBwa3MpXHJcbiAgICAgIClcclxuICAgICkobW9kYWxEYXRhKVxyXG4pO1xyXG5cclxuY29uc3QgaXNBZGQgPSBSLmlmRWxzZShcclxuICBSLnByb3BFcShcInR5cGVcIiwgXCJBZGQgTWFwcGluZ1wiKSxcclxuICBSaWdodCxcclxuICBSLmFsd2F5cyhMZWZ0KFtdKSlcclxuKTtcclxuY29uc3QgZ2V0QWRkZXIgPSByZWFkZXIoXHJcbiAgKHtcclxuICAgIHBrcyxcclxuICAgIGVyck1zZyxcclxuICAgIG1vZGFsRGF0YSxcclxuICAgIHRhYmxlRGF0YSxcclxuICAgIHBlcmlvZG8sXHJcbiAgICBwZXJpb2RvS2V5cyxcclxuICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gIH06IHtcclxuICAgIHBrczogYW55O1xyXG4gICAgZXJyTXNnOiBzdHJpbmc7XHJcbiAgICBtb2RhbERhdGE6IGFueTtcclxuICAgIHRhYmxlRGF0YTogYW55O1xyXG4gICAgcGVyaW9kbzogYW55O1xyXG4gICAgcGVyaW9kb0tleXM6IGFueTtcclxuICAgIHBlcmlvZG9FcnJvck1zZzogYW55O1xyXG4gIH0pID0+XHJcbiAgICBSLnBpcGUoXHJcbiAgICAgIGlzQWRkLFxyXG4gICAgICBSLmNoYWluKHggPT5cclxuICAgICAgICBleGNsdWRlc1ByaW1hcnlLZXkoXHJcbiAgICAgICAgICB0YWJsZURhdGEsXHJcbiAgICAgICAgICB4LFxyXG4gICAgICAgICAgcGtzLFxyXG4gICAgICAgICAgZXJyTXNnLFxyXG4gICAgICAgICAgcGVyaW9kbyxcclxuICAgICAgICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgICAgICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgICAgICAgKVxyXG4gICAgICApLFxyXG4gICAgICBSLm1hcCgobTogYW55KSA9PiBSLmFzc29jKFwibW9kXCIsIG0udHlwZSwgbS5yb3cpKSxcclxuICAgICAgUi5tYXAoeCA9PiBSLnByZXBlbmQoeCwgdGFibGVEYXRhKSlcclxuICAgICkobW9kYWxEYXRhKVxyXG4pO1xyXG5jb25zdCBnZXRNb2RpZmllcnMgPSBSLnRyYXZlcnNlPGFueSwgYW55LCBhbnk+KHJlYWRlci5vZiwgUi5pZGVudGl0eSwgW1xyXG4gIGdldFVwZGF0ZXIsXHJcbiAgZ2V0QWRkZXJcclxuXSkubWFwKFIuYXBwbHkoY29uY2F0KSk7XHJcblxyXG5leHBvcnQgY29uc3QgY29tbWl0UGVyaW9kaU1vZGlmaWNhdGlvbiA9ICh7XHJcbiAgcGtzLFxyXG4gIGVyck1zZyxcclxuICBtb2RhbERhdGEsXHJcbiAgdGFibGVEYXRhLFxyXG4gIHBlcmlvZG8sXHJcbiAgcGVyaW9kb0tleXMsXHJcbiAgcGVyaW9kb0Vycm9yTXNnXHJcbn06IHtcclxuICBwa3M6IGFueTtcclxuICBlcnJNc2c6IHN0cmluZztcclxuICBtb2RhbERhdGE6IGFueTtcclxuICB0YWJsZURhdGE6IGFueTtcclxuICBwZXJpb2RvOiBhbnk7XHJcbiAgcGVyaW9kb0tleXM6IGFueTtcclxuICBwZXJpb2RvRXJyb3JNc2c6IGFueTtcclxufSkgPT5cclxuICBnZXRNb2RpZmllcnMucnVuKHtcclxuICAgIHBrcyxcclxuICAgIGVyck1zZyxcclxuICAgIG1vZGFsRGF0YSxcclxuICAgIHRhYmxlRGF0YSxcclxuICAgIHBlcmlvZG8sXHJcbiAgICBwZXJpb2RvS2V5cyxcclxuICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gIH0pO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY29tbWl0UGVyaW9kaU1vZGlmaWNhdGlvbjtcclxuIl19